<!DOCTYPE html>
<html>
<head>
    <title>GDC 2017</title>

    <style>
        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #renderCanvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }
    </style>

    <script src="scripts/dat.gui.min.js"></script>
    <script src="scripts/babylon.max.js"></script>
    <script src="scripts/babylon.glTFFileLoader.js"></script>
</head>
<body>
    <canvas id="renderCanvas"></canvas>

    <script>
        var Options = function () {
            this.environment = "grayish";
        }

        var options = new Options();

        var gui = new dat.GUI({ autoplace: false, width: 500 });

        var environmentNames = [
            "grayish",
            "country",
            "night_byopenfootage",
            "indoor_by_gregzaal_adaptive_samples"
        ];

        gui.add(options, "environment", environmentNames).onChange(updateEnvironment);

        var canvas = document.getElementById("renderCanvas");
        var engine = null;
        var camera = null;
        var scene = null;
        var hdrSkybox = null;
        var alpha = 4.712;
        var beta = 1.2;
        var radius = 3;
        var hdrTextures = {};

        load("models/2.0/BoomBox/glTF/", "BoomBox.gltf");

        window.addEventListener("resize", function () {
            if (engine) {
                engine.resize();
            }
        });

        function load(rootUrl, fileName) {
            if (engine) {
                alpha = camera.alpha;
                beta = camera.beta;
                radius = camera.radius;

                engine.dispose();
            }

            engine = new BABYLON.Engine(canvas, true);
            engine.enableOfflineSupport = false;

            BABYLON.GLTFFileLoader.IncrementalLoading = false;

            BABYLON.SceneLoader.ShowLoadingScreen = false;

            BABYLON.SceneLoader.Load(rootUrl, fileName, engine, function (loadedScene) {
                scene = loadedScene;

                camera = new BABYLON.ArcRotateCamera("camera", alpha, beta, radius, BABYLON.Vector3.Zero(), scene);
                camera.attachControl(canvas);
                camera.wheelPrecision = 100.0;
                camera.minZ = 0.1;
                camera.maxZ = 1000;

                for (var i = 0; i < environmentNames.length; i++) {
                    var name = environmentNames[i];
                    hdrTextures[name] = new BABYLON.HDRCubeTexture("images/" + name + ".babylon.hdr", scene);
                }

                updateEnvironment();

                var time = performance.now();
                engine.runRenderLoop(function () {
                    var delta = performance.now() - time;
                    time = performance.now();
                    camera.alpha -= 0.25 / delta;

                    scene.render();
                });
            });
        }

        function updateEnvironment() {
            if (!scene) {
                return;
            }

            if (hdrSkybox) {
                scene.removeMesh(hdrSkybox);
            }

            var hdrTexture = hdrTextures[options.environment];

            for (var i = 0; i < scene.meshes.length; i++) {
                var material = scene.meshes[i].material;
                if (material instanceof BABYLON.MultiMaterial) {
                    for (var j = 0; j < material.subMaterials.length; j++) {
                        var subMaterial = material.subMaterials[j];
                        if (subMaterial instanceof BABYLON.PBRMaterial) {
                            subMaterial.reflectionTexture = hdrTexture;
                        }
                    }
                }
            }

            hdrSkybox = BABYLON.Mesh.CreateBox("hdrSkyBox", 1000.0, scene);
            var hdrSkyboxMaterial = new BABYLON.PBRMaterial("skyBox", scene);
            hdrSkyboxMaterial.backFaceCulling = false;
            hdrSkyboxMaterial.reflectionTexture = hdrTexture.clone();
            hdrSkyboxMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;
            hdrSkyboxMaterial.microSurface = 1.0;
            hdrSkyboxMaterial.cameraExposure = 0.6;
            hdrSkyboxMaterial.cameraContrast = 1.6;
            hdrSkyboxMaterial.disableLighting = true;
            hdrSkybox.material = hdrSkyboxMaterial;
            hdrSkybox.infiniteDistance = true;
        }
    </script>
</body>
</html>
